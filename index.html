<!doctype html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width">
    <title>Testing Verovio</title>
    <!--Output appearance modification stylesheet-->
    <link href="stylesheet.css" rel="stylesheet" type="text/css"/>
    <!--Loads Verovio's hosted JavaScript toolkit-->
    <script src="https://www.verovio.org/javascript/latest/verovio-toolkit-wasm.js" defer></script>
    <!-- A JavaScript MIDI player; provides  callback function that gives current playback time -->
    <script src='https://www.midijs.net/lib/midi.js'></script>
    <!--Starts Verovio-->
    <script>
        //Wait for verovio module to fully load as required
        document.addEventListener("DOMContentLoaded", (event) => {
        verovio.module.onRuntimeInitialized = () => {
            //creates a new instance of Verovio's toolkit
            let tk = new verovio.toolkit();
            // An array to keep xpath queries for selecting editorial markup
            let appXPath = [];
           // Keep a variable to the notation div id
            let notationElement = document.getElementById("notation");
            /*
            --------------OPTION SETTINGS--------------
                - All: https://book.verovio.org/toolkit-reference/toolkit-options.html
                - Scaling: https://book.verovio.org/advanced-topics/controlling-the-svg-output.html#scaling
            */
            console.log("Verovio options:", tk.getOptions()); //Lists available options
            let options = {
                svgAdditionalAttribute: ["note@pname", "note@oct"], //specify which attributes from MEI can be made available in the SVG output (pitch name and octave in example) as data-* for query selection
                justifyVertically: true,
                //scale down to fit containers/embed in divs
                svgViewBox: true,
                //avoids need for page dimension calculation; SVG will always have the same size reardless of scale percentage
                scaleToPageSize: true,
                //Requires key info stored in staffDef@key.pname/staffDef@key.accid or keySig@pname/keySig@accid
                transpose: "P1", //Numbers for semitone transposition, [P/m/d/dd/M/A/AA]Number for intervals, A1 for sharp of current, [A-G]#/b for specific key to closest tonic. Mode is unaltered
                //for lyric change
                appXPathQuery: appXPath,
            };
            //--------------FILE LOADING--------------
            function loadFile(){
                //load MEI file from remote server
                //fetch("https://raw.githubusercontent.com/IsabelBou/MeiTestFiles/main/DoM.mei")
                fetch("https://raw.githubusercontent.com/marenzio/marenzio.github.io/master/mei/M-04-6/M_04_6_02_Di_nettare_amoroso_ebro_la_mente.mei")
                .then( (response) => response.text() )
                .then( (meiXML) => {
                    //renders MEI into SVG
                    tk.setOptions(options);
                    tk.setOptions({appXPathQuery: appXPath});
                    let svg = tk.renderData(meiXML, {});
                    //look for HTML elements with same id and set it this content
                    document.getElementById("notation").innerHTML = svg;
                //--------------SELECTIVE CSS--------------
                    // Get all the rests by selecting <g> with attribute class 'rest'
                    let rests = document.querySelectorAll('g.rest');
                    // change all rests color by setting their style.fill value
                    for (let rest of rests) {
                        rest.style.fill = "red";
                    }
                    // Get all the notes with @pname="c" and @oct="4" and change their color
                    let c4s = document.querySelectorAll('g[data-pname="c"][data-oct="4"]');
                    for (let c4 of c4s) {
                        c4.style.fill = "blue";
                    }
                });
            }
        //--------------MIDI PLAYBACK--------------
            //handler to play MIDI file
            const playMIDIHandler = function () {
                // Get the MIDI file from the Verovio toolkit
                let base64midi = tk.renderToMIDI();
                // Add the data URL prefixes describing the content
                let midiString = 'data:audio/midi;base64,' + base64midi;
                // Pass it to play to MIDIjs
                MIDIjs.play(midiString);
            }
            //handler to stop playing MIDI file
            const stopMIDIHandler = function () {
                MIDIjs.stop();
            }
            //Buttons to play and stop the MIDI
            document.getElementById("playMIDI").addEventListener("click", playMIDIHandler);
            document.getElementById("stopMIDI").addEventListener("click", stopMIDIHandler);
        //--------------HIGHLIGHT WHILE PLAYING--------------
            const midiHightlightingHandler = function (event) {
                // Remove highlight (attribute 'playing') of all previously played notes
                let playingNotes = document.querySelectorAll('g.note.playing');
                for (let playingNote of playingNotes) playingNote.classList.remove("playing");
                // Gets list of notes being played at a given time in milliseconds (time from the player is in seconds)
                let currentElements = tk.getElementsAtTime(event.time * 1000);
                // Get all notes 'playing' and set as class
                for (note of currentElements.notes) {
                    let noteElement = document.getElementById(note);
                    if (noteElement) noteElement.classList.add("playing");
                }
            }
            //bind the MIDIjs player with reviously defined callback function
            MIDIjs.player_callback = midiHightlightingHandler;
            //--------------VERSION HANDLER--------------
            const originalHandler = function () {
                appXPath = [];
                loadFile();
            }
            const contrafactumHandler = function () {
                appXPath = ["./rdg[@source='English']"];
                loadFile();
            }
            document.getElementById("original").addEventListener("click", originalHandler);
            document.getElementById("contrafactum").addEventListener("click", contrafactumHandler);
            loadFile();
        }
    });
    </script>
  </head>
  <body>
    <h1>Verovio Test</h1>
    <!--Buttons for MIDI control-->
    <button id="playMIDI">Play</button>
    <button id="stopMIDI">Stop</button>
    <!--Buttons for textual variation switch-->
    <button id="original">Original (Italian)</button>
    <button id="contrafactum">Contrafactum (English)</button>
    <!-- The div where we are going to insert the SVG -->
    <div id="notation"></div>
  </body>
</html>
